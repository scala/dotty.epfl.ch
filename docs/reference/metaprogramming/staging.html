<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>Multi-Stage Programming</title><link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico"></link><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="../../../scripts/diagram.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><script type="text/javascript" src="../../../scripts/fast-navigation-loader.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"><span><img src="../../../project-logo/logo.svg"></img></span><span><div class="projectName">Scala 3</div></span><span><div class="projectVersion">3.0.0-M3-bin-20201213-e8d748e-NIGHTLY</div></span></div><div id="paneSearch"></div><nav id="sideMenu"></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="docs.reference.metaprogramming.staging.md////PointingToDeclaration//-1055800790">
    <div class="breadcrumbs"><a href="../../index.html">Scala 3</a>/<a href="../../Reference/index.html">Reference</a>/<a href="../../Metaprogramming/index.html">Metaprogramming</a>/<a href=".html">Multi-Stage Programming</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>Multi-Stage Programming</h1> 
     <div class="byline"> <a href="https://github.com/lampepfl/dotty/edit/master/docs/docs/reference/metaprogramming/staging.md"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <p>The framework expresses at the same time compile-time metaprogramming and multi-stage programming. We can think of compile-time metaprogramming as a two stage compilation process: one that we write the code in top-level splices, that will be used for code generation (macros) and one that will perform all necessary evaluations at compile-time and an object program that we will run as usual. What if we could synthesize code at run-time and offer one extra stage to the programmer? Then we can have a value of type <code>Expr[T]</code> at run-time that we can essentially treat as a typed-syntax tree that we can either <em>show</em> as a string (pretty-print) or compile and run. If the number of quotes exceeds the number of splices by more than one (effectively handling at run-time values of type <code>Expr[Expr[T]]</code>, <code>Expr[Expr[Expr[T]]]</code>, ...) then we talk about Multi-Stage Programming.</p> 
    <p>The motivation behind this <em>paradigm</em> is to let runtime information affect or guide code-generation.</p> 
    <p>Intuition: The phase in which code is run is determined by the difference between the number of splice scopes and quote scopes in which it is embedded.</p> 
    <ul> 
     <li> <p>If there are more splices than quotes, the code is run at compile-time i.e. as a macro. In the general case, this means running an interpreter that evaluates the code, which is represented as a typed abstract syntax tree. The interpreter can fall back to reflective calls when evaluating an application of a previously compiled method. If the splice excess is more than one, it would mean that a macroâ€™s implementation code (as opposed to the code it expands to) invokes other macros. If macros are realized by interpretation, this would lead to towers of interpreters, where the first interpreter would itself interpret an interpreter code that possibly interprets another interpreter and so on.</p> </li> 
     <li> <p>If the number of splices equals the number of quotes, the code is compiled and run as usual.</p> </li> 
     <li>If the number of quotes exceeds the number of splices, the code is staged. That is, it produces a typed abstract syntax tree or type structure at run-time. A quote excess of more than one corresponds to multi-staged programming.</li> 
    </ul> 
    <p>Providing an interpreter for the full language is quite difficult, and it is even more difficult to make that interpreter run efficiently. So we currently impose the following restrictions on the use of splices.</p> 
    <ol> 
     <li> <p>A top-level splice must appear in an inline method (turning that method into a macro)</p> </li> 
     <li> <p>The splice must call a previously compiled method passing quoted arguments, constant arguments or inline arguments.</p> </li> 
     <li>Splices inside splices (but no intervening quotes) are not allowed.</li> 
    </ol> 
    <h2><a href="#api" id="api" class="anchor"></a>API</h2> 
    <p>The framework as discussed so far allows code to be staged, i.e. be prepared to be executed at a later stage. To run that code, there is another method in class <code>Expr</code> called <code>run</code>. Note that <code>$</code> and <code>run</code> both map from <code>Expr[T]</code> to <code>T</code> but only <code>$</code> is subject to the PCP, whereas <code>run</code> is just a normal method. Run provides a <code>Quotes</code> that can be used to show the expression in the scope of <code>run</code>. On the other hand <code>withQuotes</code> provides a <code>Quotes</code> without evaluating the expression.</p> 
    <pre><code class="language-scala">package scala.quoted.staging

def run[T](expr: Quotes ?=&gt; Expr[T])(using toolbox: Toolbox): T = ...

def withQuotes[T](thunk: Quotes ?=&gt; T)(using toolbox: Toolbox): T = ...
</code></pre> 
    <h2><a href="#create-a-new-dotty-project-with-staging-enabled" id="create-a-new-dotty-project-with-staging-enabled" class="anchor"></a>Create a new Dotty project with staging enabled</h2> 
    <pre><code class="language-shell">sbt new scala/scala3-staging.g8
</code></pre> 
    <p>From <a href="https://github.com/scala/scala3-staging.g8">scala/scala3-staging.g8</a>.</p> 
    <p>It will create a project with the necessary dependencies and some examples.</p> 
    <p>In case you prefer to create the project on your own, make sure to define the following dependency in your build.sbt</p> 
    <pre><code class="language-scala">libraryDependencies += "ch.epfl.lamp" %% "scala3-staging" % scalaVersion.value
</code></pre> 
    <p>and in case you use <code>scalac</code>/<code>scala</code> directly, then use the <code>-with-compiler</code> flag for both:</p> 
    <pre><code class="language-shell">scalac -with-compiler -d out Test.scala
scala -with-compiler -classpath out Test
</code></pre> 
    <h2><a href="#example" id="example" class="anchor"></a>Example</h2> 
    <p>Now take exactly the same example as in <a href="macros.html">Macros</a>. Assume that we do not want to pass an array statically but generate code at run-time and pass the value, also at run-time. Note, how we make a future-stage function of type <code>Expr[Array[Int] =&gt; Int]</code> in line 6 below. Using <code>run { ... }</code> we can evaluate an expression at runtime. Within the scope of <code>run</code> we can also invoke <code>show</code> on an expression to get a source-like representation of the expression.</p> 
    <pre><code class="language-scala">import scala.quoted.staging._

// make available the necessary toolbox for runtime code generation
given Toolbox = Toolbox.make(getClass.getClassLoader)

val f: Array[Int] =&gt; Int = run {
  val stagedSum: Expr[Array[Int] =&gt; Int] = '{ (arr: Array[Int]) =&gt; ${sum('arr)}}
  println(stagedSum.show) // Prints "(arr: Array[Int]) =&gt; { var sum = 0; ... }"
  stagedSum
}

f.apply(Array(1, 2, 3)) // Returns 6
</code></pre> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span>Generated by&nbsp;<a href="https://github.com/lampepfl/dotty/tree/master/scala3doc"><img src="../../../images/scala3doc_logo.svg" alt="Scala3doc" class="scala3doc_logo"></img></a></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
