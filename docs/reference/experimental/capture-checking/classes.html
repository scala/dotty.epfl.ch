<!DOCTYPE html><html data-githubContributorsUrl="https://api.github.com/repos/scala/scala3" data-githubContributorsFilename="/docs/_docs/reference/experimental/capture-checking/classes.md" data-pathToRoot="../../../../" data-rawLocation="docs/reference/experimental/capture-checking/classes" data-dynamicSideMenu="false"><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"></meta><title>Capture Checking of Classes</title><link rel="shortcut icon" type="image/x-icon" href="../../../../favicon.ico"></link><script type="text/javascript" src="../../../../scripts/theme.js"></script><script type="text/javascript" src="../../../../scripts/searchData.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/scastieConfiguration.js" defer="true"></script><link rel="stylesheet" href="../../../../styles/theme/bundle.css"></link><link rel="stylesheet" href="../../../../styles/theme/components/bundle.css"></link><link rel="stylesheet" href="../../../../styles/theme/components/button/bundle.css"></link><link rel="stylesheet" href="../../../../styles/theme/layout/bundle.css"></link><link rel="stylesheet" href="../../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../../styles/code-snippets.css"></link><link rel="stylesheet" href="../../../../styles/searchbar.css"></link><link rel="stylesheet" href="../../../../styles/social-links.css"></link><link rel="stylesheet" href="../../../../styles/versions-dropdown.css"></link><link rel="stylesheet" href="../../../../styles/content-contributors.css"></link><link rel="stylesheet" href="../../../../styles/fontawesome.css"></link><script type="text/javascript" src="../../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/scaladoc-scalajs.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/contributors.js" defer="true"></script><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="https://scastie.scala-lang.org/embedded.js" defer="true"></script><script type="text/javascript" src="../../../../scripts/data.js" defer="true"></script><link rel="stylesheet" href="../../../../styles/staticsitestyles.css"></link><script>var pathToRoot = "../../../../";</script><script>var versionsDictionaryUrl = "https://scala-lang.org/api/versions.json";</script><link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="/css/dottydoc.css"></head><body><div id=""><div id="header" class="body-small"><div class="header-container-left"><a href="../../../../" class="logo-container"><span id="project-logo" class="project-logo"><img src="../../../../project-logo/logo.svg"></img></span><span id="dark-project-logo" class="project-logo"><img src="../../../../project-logo/logo_dark.svg"></img></span><span class="project-name h300">Scala 3</span></a><span onclick="dropdownHandler(event)" class="text-button with-arrow" id="dropdown-trigger"><a><div class="projectVersion">3.8.0-RC1-bin-20250821-0a7f843-NIGHTLY</div></a></span><div id="version-dropdown" class="dropdown-menu"></div></div><div class="header-container-right"><button id="search-toggle" class="icon-button"></button><a href="https://docs.scala-lang.org/" class="text-button">Learn</a><a href="https://www.scala-lang.org/download/" class="text-button">Install</a><a href="https://scastie.scala-lang.org" class="text-button">Playground</a><a href="https://index.scala-lang.org" class="text-button">Find A Library</a><a href="https://www.scala-lang.org/community/" class="text-button">Community</a><a href="https://www.scala-lang.org/blog/" class="text-button">Blog</a><span id="theme-toggle" class="icon-button"></span><span id="mobile-menu-toggle" class="icon-button hamburger"></span></div></div><div id="mobile-menu"><div class="mobile-menu-header body-small"><span class="mobile-menu-logo"><span id="project-logo" class="project-logo"><img src="../../../../project-logo/logo.svg"></img></span><span id="dark-project-logo" class="project-logo"><img src="../../../../project-logo/logo_dark.svg"></img></span><span class="project-name h300">Scala 3</span></span><button id="mobile-menu-close" class="icon-button close"></button></div><div class="mobile-menu-container body-medium"><input id="mobile-scaladoc-searchbar-input" class="scaladoc-searchbar-input" type="search" placeholder="Find anything"></input><a href="https://docs.scala-lang.org/" class="mobile-menu-item">Learn</a><a href="https://www.scala-lang.org/download/" class="mobile-menu-item">Install</a><a href="https://scastie.scala-lang.org" class="mobile-menu-item">Playground</a><a href="https://index.scala-lang.org" class="mobile-menu-item">Find A Library</a><a href="https://www.scala-lang.org/community/" class="mobile-menu-item">Community</a><a href="https://www.scala-lang.org/blog/" class="mobile-menu-item">Blog</a><span id="mobile-theme-toggle" class="mobile-menu-item mode"></span></div></div><span id="mobile-sidebar-toggle" class="floating-button"></span><div id="leftColumn" class="body-small"><div class="switcher-container"><a id="docs-nav-button" class="switcher h100 selected" href="../../../../index.html">Docs</a><a id="api-nav-button" class="switcher h100 " href="../../../../api/index.html">API</a></div><nav id="docs-nav" class="side-menu"><div class="ni n0 expanded"><span class="nh h100 expanded cs de"><button class="ar icon-button expanded"></button><a href="../../index.html"><span>Reference</span></a></span><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../new-types/index.html"><span>New Types</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../new-types/intersection-types.html"><span>Intersection Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../new-types/union-types.html"><span>Union Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../new-types/type-lambdas.html"><span>Type Lambdas</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../new-types/match-types.html"><span>Match Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../new-types/dependent-function-types.html"><span>Dependent Function Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../new-types/polymorphic-function-types.html"><span>Polymorphic Function Types</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../enums/index.html"><span>Enums</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../enums/enums.html"><span>Enumerations</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../enums/adts.html"><span>Algebraic Data Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../enums/desugarEnums.html"><span>Translation of Enums and ADTs</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../contextual/index.html"><span>Contextual Abstractions</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../contextual/givens.html"><span>Given Instances</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/using-clauses.html"><span>Using Clauses</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/context-bounds.html"><span>Context Bounds</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/deferred-givens.html"><span>Deferred Givens</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/given-imports.html"><span>Importing Givens</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/more-givens.html"><span>Other Forms Of Givens</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/extension-methods.html"><span>Extension Methods</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/right-associative-extension-methods.html"><span>Right-Associative Extension Methods: Details</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/type-classes.html"><span>Implementing Type classes</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/derivation.html"><span>Type Class Derivation</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/derivation-macro.html"><span>How to write a type class `derived` method using macros</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/multiversal-equality.html"><span>Multiversal Equality</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/context-functions.html"><span>Context Functions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/conversions.html"><span>Implicit Conversions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/by-name-context-parameters.html"><span>By-Name Context Parameters</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../contextual/relationship-implicits.html"><span>Relationship with Scala 2 Implicits</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../metaprogramming/index.html"><span>Metaprogramming</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/inline.html"><span>Inline</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/compiletime-ops.html"><span>Compile-time operations</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/macros.html"><span>Macros</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/simple-smp.html"><span>The Meta-theory of Symmetric Metaprogramming</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/staging.html"><span>Run-Time Multi-Stage Programming</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/reflection.html"><span>Reflection</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../metaprogramming/tasty-inspect.html"><span>TASTy Inspection</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../other-new-features/index.html"><span>Other New Features</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/trait-parameters.html"><span>Trait Parameters</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/transparent-traits.html"><span>Transparent Traits and Classes</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/creator-applications.html"><span>Universal Apply Methods</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/export.html"><span>Export Clauses</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/opaques.html"><span>Opaque Type Aliases</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/opaques-details.html"><span>Opaque Type Aliases: More Details</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/named-tuples.html"><span>Named Tuples</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/open-classes.html"><span>Open Classes</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/parameter-untupling.html"><span>Parameter Untupling</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/kind-polymorphism.html"><span>Kind Polymorphism</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/matchable.html"><span>The Matchable Trait</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/threadUnsafe-annotation.html"><span>The @threadUnsafe annotation</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/targetName.html"><span>The @targetName annotation</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/control-syntax.html"><span>New Control Syntax</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/indentation.html"><span>Optional Braces</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/safe-initialization.html"><span>Safe Initialization</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/type-test.html"><span>TypeTest</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/experimental-defs.html"><span>Experimental Definitions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/preview-defs.html"><span>Preview Definitions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/binary-literals.html"><span>Binary Integer Literals</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/toplevel-definitions.html"><span>Toplevel Definitions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/better-fors.html"><span>Better fors</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../other-new-features/runtimeChecked.html"><span>The runtimeChecked method</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../changed-features/index.html"><span>Other Changed Features</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../changed-features/numeric-literals.html"><span>Numeric Literals</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/structural-types.html"><span>Programmatic Structural Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/operators.html"><span>Rules for Operators</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/wildcards.html"><span>Wildcard Arguments in Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/imports.html"><span>Imports</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/type-inference.html"><span>Changes in Type Inference</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/implicit-resolution.html"><span>Changes in Implicit Resolution</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/implicit-conversions.html"><span>Implicit Conversions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/overload-resolution.html"><span>Changes in Overload Resolution</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/match-syntax.html"><span>Match Expressions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/vararg-splices.html"><span>Vararg Splices</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/pattern-bindings.html"><span>Pattern Bindings</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/pattern-matching.html"><span>Option-less pattern matching</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/eta-expansion.html"><span>Automatic Eta Expansion</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/compiler-plugins.html"><span>Changes in Compiler Plugins</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/lazy-vals-init.html"><span>Lazy Vals Initialization</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/main-functions.html"><span>Main Methods</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../changed-features/interpolation-escapes.html"><span>Escapes in interpolations</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../dropped-features/index.html"><span>Dropped Features</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/delayed-init.html"><span>Dropped: DelayedInit</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/macros.html"><span>Dropped: Scala 2 Macros</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/existential-types.html"><span>Dropped: Existential Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/type-projection.html"><span>Dropped: General Type Projection</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/do-while.html"><span>Dropped: Do-While</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/procedure-syntax.html"><span>Dropped: Procedure Syntax</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/early-initializers.html"><span>Dropped: Early Initializers</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/class-shadowing.html"><span>Dropped: Class Shadowing</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/limit22.html"><span>Dropped: Limit 22</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/xml.html"><span>Dropped: XML Literals</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/symlits.html"><span>Dropped: Symbol Literals</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/auto-apply.html"><span>Dropped: Auto-Application</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/weak-conformance.html"><span>Dropped: Weak Conformance</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/nonlocal-returns.html"><span>Deprecated: Nonlocal Returns</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/this-qualifier.html"><span>Dropped: private[this] and protected[this]</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../dropped-features/wildcard-init.html"><span>Dropped: Wildcard Initializer</span></a></span></div></div><div class="ni n1 "><span class="nh de"><a href="../../preview/index.html"><span>Preview</span></a></span></div><div class="ni n1 expanded"><span class="nh h100 expanded cs de"><button class="ar icon-button expanded"></button><a href="../index.html"><span>Experimental</span></a></span><div class="ni n2 "><span class="nh de"><a href="../canthrow.html"><span>CanThrow Capabilities</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../erased-defs.html"><span>Erased Definitions</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../named-typeargs.html"><span>Named Type Arguments</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../numeric-literals.html"><span>Numeric Literals</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../explicit-nulls.html"><span>Explicit Nulls</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../main-annotation.html"><span>MainAnnotation</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../into.html"><span>The `into` Type and Modifier</span></a></span></div><div class="ni n2 expanded"><span class="nh h100 expanded cs de"><button class="ar icon-button expanded"></button><a href="index.html"><span>Capture Checking</span></a></span><div class="ni n3 "><span class="nh de"><a href="basics.html"><span>Capture Checking Basics</span></a></span></div><div class="ni n3 expanded"><span class="nh h100 selected de"><a href="#"><span>Capture Checking of Classes</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="polymorphism.html"><span>Capability Polymorphism</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="scoped-caps.html"><span>Scoped Caps</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="classifiers.html"><span>Capability Classifiers</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="checked-exceptions.html"><span>Checked Exceptions</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="separation-checking.html"><span>Separation Checking</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="how-to-use.html"><span>How to Use the Capture Checker</span></a></span></div><div class="ni n3 "><span class="nh de"><a href="internals.html"><span>Capture Checking Internals</span></a></span></div></div><div class="ni n2 "><span class="nh de"><a href="../purefuns.html"><span>Pure Function Syntax</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../tupled-function.html"><span>Tupled Function</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../modularity.html"><span>Modularity Improvements</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../typeclasses.html"><span>Better Support for Type Classes</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../unrolled-defs.html"><span>Automatic Parameter Unrolling</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../package-object-values.html"><span>Reference-able Package Objects</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../quoted-patterns-with-polymorphic-functions.html"><span>Quoted Patterns with Polymorphic Functions</span></a></span></div></div><div class="ni n1 "><span class="nh de"><a href="../../syntax.html"><span>Scala 3 Syntax Summary</span></a></span></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../language-versions/index.html"><span>Language Versions</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../language-versions/source-compatibility.html"><span>Source Compatibility</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../language-versions/binary-compatibility.html"><span>Binary Compatibility</span></a></span></div></div><div class="ni n1 "><span class="nh de"><a href="../../soft-modifier.html"><span>Soft Keywords</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../features-classification.html"><span>A Classification of Proposed Language Features</span></a></span></div></div><div class="ni n0"><span class="nh de"><button class="ar icon-button "></button><a href="../../../contributing/index.html"><span>Contributing</span></a></span><div class="ni n1 "><span class="nh de"><a href="../../../contributing/getting-started.html"><span>Getting Started</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/setting-up-your-ide.html"><span>Setting up your IDE</span></a></span></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../../contributing/diagnosing-your-issue/index.html"><span>Diagnosing your issue</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../../contributing/diagnosing-your-issue/reproduce.html"><span>Reproducing an Issue</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/diagnosing-your-issue/cause.html"><span>Finding the Cause of an Issue</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/diagnosing-your-issue/areas.html"><span>Common Issue Locations</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../../contributing/debugging-the-compiler/index.html"><span>Debugging the Compiler</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../../contributing/debugging-the-compiler/ide-debugging.html"><span>Debugging with your IDE</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/debugging-the-compiler/inspection.html"><span>How to Inspect Values</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/debugging-the-compiler/other-debugging.html"><span>Other Debugging Techniques</span></a></span></div></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/testing.html"><span>Testing Your Changes</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/scaladoc.html"><span>Scaladoc</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/community-build.html"><span>Community Build</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/sending-in-a-pr.html"><span>Sending in a pull request</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../contributing/cheatsheet.html"><span>Command Cheatsheet</span></a></span></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../../contributing/procedures/index.html"><span>Procedures</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../../contributing/procedures/release.html"><span>Release Procedure</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/procedures/vulpix.html"><span>Test Vulpix Framework</span></a></span></div></div><div class="ni n1"><span class="nh de"><button class="ar icon-button "></button><a href="../../../contributing/architecture/index.html"><span>High Level Architecture</span></a></span><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/lifecycle.html"><span>Compiler Overview</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/context.html"><span>Contexts</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/phases.html"><span>Compiler Phases</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/types.html"><span>Compiler Types</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/time.html"><span>Time in the Compiler</span></a></span></div><div class="ni n2 "><span class="nh de"><a href="../../../contributing/architecture/symbols.html"><span>Symbols</span></a></span></div></div></div><div class="ni n0"><span class="nh de"><button class="ar icon-button "></button><a href="../../../internals/index.html"><span>Internals</span></a></span><div class="ni n1 "><span class="nh de"><a href="../../../internals/backend.html"><span>Backend Internals</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/classpaths.html"><span>Classpaths</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/contexts.html"><span>Contexts</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/dotc-scalac.html"><span>Differences between Scalac and Dotty</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/higher-kinded-v2.html"><span>Higher-Kinded Types in Dotty</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/overall-structure.html"><span>Dotty Overall Structure</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/explicit-nulls.html"><span>Explicit Nulls</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/periods.html"><span>Dotc&apos;s concept of time</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/syntax.html"><span>Scala 3 Syntax Summary</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/type-system.html"><span>Type System</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/dotty-internals-1-notes.html"><span>Dotty Internals 1: Trees &amp; Symbols (Meeting Notes)</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/debug-macros.html"><span>Debug Macros</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/gadts.html"><span>GADTs - Broad overview</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/coverage.html"><span>Code Coverage for Scala 3</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../internals/best-effort-compilation.html"><span>Best Effort Compilation</span></a></span></div></div><div class="ni n0"><span class="nh de"><button class="ar icon-button "></button><a href="../../../../blog/index.html"><span>Blog (archive)</span></a></span><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2021/06/25/scala301-rc2.html"><span>Scala 3.0.1-RC2 – backports of critical bugfixes</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2021/06/07/scala3.0.1-rc1-release.html"><span>Scala 3.0.1-RC1 – further stabilising the compiler</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2021/04/21/scala3-rc3.html"><span>Scala 3.0.0-RC3 – bug fixes for 3.0.0 stable</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2021/03/31/scala3-rc2.html"><span>Scala 3.0.0-RC2 – getting ready for 3.0.0</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2021/02/17/scala3-rc1.html"><span>Scala 3.0.0-RC1 – first release candidate is here</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/12/18/scala3-m3.html"><span>Scala 3.0.0-M3: developer&apos;s preview before RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/11/09/scala3-m1.html"><span>Scala 3.0.0-M1 is here</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/09/21/naming-schema-change.html"><span>Dotty becomes Scala 3</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/08/31/27th-dotty-milestone-release.html"><span>Announcing Dotty 0.27.0-RC1 - ScalaJS, performance, stability</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/07/27/26th-dotty-milestone-release.html"><span>Announcing Dotty 0.26.0-RC1 - unified extension methods and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/06/22/25th-dotty-milestone-release.html"><span>Announcing Dotty 0.25.0-RC2 - speed-up of givens and change in the tuple API</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/04/29/24th-dotty-milestone-release.html"><span>Announcing Dotty 0.24.0-RC1 - 2.13.2 standard library, better error messages and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/03/18/23rd-dotty-milestone-release.html"><span>Announcing Dotty 0.23.0-RC1 - safe initialization checks, type-level bitwise operations and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2020/02/05/22nd-dotty-milestone-release.html"><span>Announcing Dotty 0.22.0-RC1 - syntactic enhancements, type-level arithmetic and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/12/20/21th-dotty-milestone-release.html"><span>Announcing Dotty 0.21.0-RC1 - explicit nulls, new syntax for `match` and conditional givens, and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/11/04/20th-dotty-milestone-release.html"><span>Announcing Dotty 0.20.0-RC1 – `with` starting indentation blocks, inline given specializations and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/09/23/19th-dotty-milestone-release.html"><span>Announcing Dotty 0.19.0-RC1 – further refinements of the syntax and the migration to 2.13.1 standard library</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/08/30/18th-dotty-milestone-release.html"><span>Announcing Dotty 0.18.1-RC1 – switch to the 2.13 standard library, indentation-based syntax and other experiments</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/07/25/17th-dotty-milestone-release.html"><span>Announcing Dotty 0.17.0-RC1 – new implicit scoping rules and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/06/11/16th-dotty-milestone-release.html"><span>Announcing Dotty 0.16.0-RC3 – the Scala Days 2019 Release</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/05/23/15th-dotty-milestone-release.html"><span>Announcing Dotty 0.15.0-RC1 – the fully bootstrapped compiler</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/04/15/14th-dotty-milestone-release.html"><span>Announcing Dotty 0.14.0-RC1 with export, immutable arrays, creator applications and more</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/03/05/13th-dotty-milestone-release.html"><span>Announcing Dotty 0.13.0-RC1 with Spark support, top level definitions and redesigned implicits</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2019/01/21/12th-dotty-milestone-release.html"><span>Announcing Dotty 0.12.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2018/11/30/11th-dotty-milestone-release.html"><span>Announcing Dotty 0.11.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2018/10/10/10th-dotty-milestone-release.html"><span>Announcing Dotty 0.10.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2018/07/06/ninth-dotty-milestone-release.html"><span>Announcing Dotty 0.9.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2018/04/27/eighth-dotty-milestone-release.html"><span>Announcing Dotty 0.7.0 and 0.8.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2018/03/05/seventh-dotty-milestone-release.html"><span>Announcing Dotty 0.6.0 and 0.7.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2017/12/01/fifth-dotty-milestone-release.html"><span>Announcing Dotty 0.5.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2017/10/16/fourth-dotty-milestone-release.html"><span>Announcing Dotty 0.4.0-RC1</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2017/09/07/third-dotty-milestone-release.html"><span>Announcing Dotty 0.3.0-RC2</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2017/07/12/second-dotty-milestone-release.html"><span>Announcing Dotty 0.2.0-RC1, with new optimizations, improved stability and IDE support</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2017/05/31/first-dotty-milestone-release.html"><span>Announcing Dotty 0.1.2-RC1, a major step towards Scala 3</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2016/12/05/implicit-function-types.html"><span>Implicit Function Types</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2016/05/05/multiversal-equality.html"><span>Multiversal Equality for Scala</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2016/02/17/scaling-dot-soundness.html"><span>Scaling DOT to Scala - Soundness</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2016/02/03/essence-of-scala.html"><span>The Essence of Scala</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2016/01/02/new-year-resolutions.html"><span>New Year Resolutions</span></a></span></div><div class="ni n1 "><span class="nh de"><a href="../../../../blog/2015/10/23/dotty-compiler-bootstraps.html"><span>We got liftoff!</span></a></span></div></div></nav></div><div id="footer" class="body-small"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/scala/scala3"><button class="icon-button gh"></button></a><a href="https://discord.com/invite/scala"><button class="icon-button discord"></button></a><a href="https://twitter.com/scala_lang"><button class="icon-button twitter"></button></a><div class="text">Copyright (c) 2002-2025, LAMP/EPFL</div></div><div class="text-mobile">Copyright (c) 2002-2025, LAMP/EPFL</div></div><div id="scaladoc-searchBar"></div><div id="main"><div class="breadcrumbs container"><a href="../../../../index.html">Scala 3</a>/<a href="../../index.html">Reference</a>/<a href="../index.html">Experimental</a>/<a href="index.html">Capture Checking</a>/<a href="classes.html">Capture Checking of Classes</a></div><div id="content" class="body-medium"><div><div id="content-wrapper">
 <div class="site-container">
  <div id="site-header"></div>
  <aside class="warning">
   <div class="icon"></div>
   <div class="content">
    This is a nightly documentation. The content of this page may not be consistent with the current stable version of language. Click <a href="https://docs.scala-lang.org/scala3/reference/experimental/capture-checking/classes.html">here</a> to find the stable version of this page.
   </div>
  </aside>
  <main>
   <header>
    <a class="text-button with-link body-small" href="https://github.com/scala/scala3/edit/main/docs/_docs/reference/experimental/capture-checking/classes.md">Edit this page on GitHub</a>
    <h1 class="h600">Capture Checking of Classes</h1>
   </header>
   <section id="introduction">
    <h2 class="h500"><a href="#introduction" class="anchor"></a>Introduction</h2>
    <p>The principles for capture checking closures also apply to classes. For instance, consider:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class Logger(using fs: FileSystem):
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def log(s: String): Unit = ... summon[FileSystem] ...
</span><span line-number="3" class=""><span class="tooltip-container"></span>
</span><span line-number="4" class=""><span class="tooltip-container"></span>def test(xfs: FileSystem): Logger^{xfs} =
</span><span line-number="5" class=""><span class="tooltip-container"></span>  Logger(xfs)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Here, class <code>Logger</code> retains the capability <code>fs</code> as a (private) field. Hence, the result of <code>test</code> is of type <code>Logger^{xfs}</code></p>
    <p>Sometimes, a tracked capability is meant to be used only in the constructor of a class, but is not intended to be retained as a field. This fact can be communicated to the capture checker by declaring the parameter as <code>@constructorOnly</code>. Example:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>import annotation.constructorOnly
</span><span line-number="2" class=""><span class="tooltip-container"></span>
</span><span line-number="3" class=""><span class="tooltip-container"></span>class NullLogger(using @constructorOnly fs: FileSystem):
</span><span line-number="4" class=""><span class="tooltip-container"></span>  ...
</span><span line-number="5" class=""><span class="tooltip-container"></span>def test2(using fs: FileSystem): NullLogger = NullLogger() // OK
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The captured references of a class include <em>local capabilities</em> and <em>argument capabilities</em>. Local capabilities are capabilities defined outside the class and referenced from its body. Argument capabilities are passed as parameters to the primary constructor of the class. Local capabilities are inherited: the local capabilities of a superclass are also local capabilities of its subclasses. Example:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class Cap extends caps.SharedCapability
</span><span line-number="2" class=""><span class="tooltip-container"></span>
</span><span line-number="3" class=""><span class="tooltip-container"></span>def test(a: Cap, b: Cap, c: Cap) =
</span><span line-number="4" class=""><span class="tooltip-container"></span>  class Super(y: Cap):
</span><span line-number="5" class=""><span class="tooltip-container"></span>    def f = a
</span><span line-number="6" class=""><span class="tooltip-container"></span>  class Sub(x: Cap) extends Super(x)
</span><span line-number="7" class=""><span class="tooltip-container"></span>    def g = b
</span><span line-number="8" class=""><span class="tooltip-container"></span>  Sub(c)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Here class <code>Super</code> has local capability <code>a</code>, which gets inherited by class <code>Sub</code> and is combined with <code>Sub</code>'s own local capability <code>b</code>. Class <code>Sub</code> also has an argument capability corresponding to its parameter <code>x</code>. This capability gets instantiated to <code>c</code> in the final constructor call <code>Sub(c)</code>. Hence, the capture set of that call is <code>{a, b, c}</code>.</p>
    <p>The capture set of the type of <code>this</code> of a class is inferred by the capture checker, unless the type is explicitly declared with a self type annotation like this one:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class C:
</span><span line-number="2" class=""><span class="tooltip-container"></span>  self: D^{a, b} =&gt; ...
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The inference observes the following constraints:</p>
    <ul>
     <li>The type of <code>this</code> of a class <code>C</code> includes all captured references of <code>C</code>.</li>
     <li>The type of <code>this</code> of a class <code>C</code> is a subtype of the type of <code>this</code> of each parent class of <code>C</code>.</li>
     <li>The type of <code>this</code> must observe all constraints where <code>this</code> is used.</li>
    </ul>
    <p>For instance, in</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class Cap extends caps.SharedCapability
</span><span line-number="2" class=""><span class="tooltip-container"></span>def test(c: Cap) =
</span><span line-number="3" class=""><span class="tooltip-container"></span>  class A:
</span><span line-number="4" class=""><span class="tooltip-container"></span>    val x: A = this
</span><span line-number="5" class=""><span class="tooltip-container"></span>    def f = println(c)  // error
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>we know that the type of <code>this</code> must be pure, since <code>this</code> is the right hand side of a <code>val</code> with type <code>A</code>. However, in the last line we find that the capture set of the class, and with it the capture set of <code>this</code>, would include <code>c</code>. This leads to a contradiction, and hence to a checking error:</p>
    <div class="snippet mono-small-block">
     <pre><code class="language-"><span line-number="1" class=""><span class="tooltip-container"></span><span class="hideable">   </span>|    def f = println(c)  // error
</span><span line-number="2" class=""><span class="tooltip-container"></span><span class="hideable">   </span>|                    ^
</span><span line-number="3" class=""><span class="tooltip-container"></span><span class="hideable">   </span>|       reference (c : Cap) is not included in the allowed capture set {}
</span><span line-number="4" class=""><span class="tooltip-container"></span><span class="hideable">   </span>|       of the enclosing class A
</span></code></pre>
     <div class="buttons"></div>
    </div>
   </section>
   <section id="capture-tunnelling">
    <h2 class="h500"><a href="#capture-tunnelling" class="anchor"></a>Capture Tunnelling</h2>
    <p>Consider the following simple definition of a <code>Pair</code> class:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class Pair[+A, +B](x: A, y: B):
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def fst: A = x
</span><span line-number="3" class=""><span class="tooltip-container"></span>  def snd: B = y
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>What happens if <code>Pair</code> is instantiated like this (assuming <code>ct</code> and <code>fs</code> are two capabilities in scope)?</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>def x: Int -&gt;{ct} String
</span><span line-number="2" class=""><span class="tooltip-container"></span>def y: Logger^{fs}
</span><span line-number="3" class=""><span class="tooltip-container"></span>def p = Pair(x, y)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The last line will be typed as follows:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>def p: Pair[Int -&gt;{ct} String, Logger^{fs}] = Pair(x, y)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>This might seem surprising. The <code>Pair(x, y)</code> value does capture capabilities <code>ct</code> and <code>fs</code>. Why don't they show up in its type at the outside?</p>
    <p>The answer is capture tunnelling. Once a type variable is instantiated to a capturing type, the capture is not propagated beyond this point. On the other hand, if the type variable is instantiated again on access, the capture information "pops out" again. For instance, even though <code>p</code> is technically pure because its capture set is empty, writing <code>p.fst</code> would record a reference to the captured capability <code>ct</code>. So if this access was put in a closure, the capability would again form part of the outer capture set. E.g.</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>() =&gt; p.fst : () -&gt; Int -&gt;{ct} String
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>In other words, references to capabilities "tunnel through" in generic instantiations from creation to access; they do not affect the capture set of the enclosing generic data constructor applications. This principle plays an important part in making capture checking concise and practical.</p>
   </section>
   <section id="a-larger-example">
    <h2 class="h500"><a href="#a-larger-example" class="anchor"></a>A Larger Example</h2>
    <p>As a larger example, we present an implementation of lazy lists and some use cases. For simplicity, our lists are lazy only in their tail part. This corresponds to what the Scala-2 type <code>Stream</code> did, whereas Scala 3's <code>LazyList</code> type computes strictly less since it is also lazy in the first argument.</p>
    <p>Here is the base trait <code>LzyList</code> for our version of lazy lists:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>trait LzyList[+A]:
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def isEmpty: Boolean
</span><span line-number="3" class=""><span class="tooltip-container"></span>  def head: A
</span><span line-number="4" class=""><span class="tooltip-container"></span>  def tail: LzyList[A]^{this}
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Note that <code>tail</code> carries a capture annotation. It says that the tail of a lazy list can potentially capture the same references as the lazy list as a whole.</p>
    <p>The empty case of a <code>LzyList</code> is written as usual:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>object LzyNil extends LzyList[Nothing]:
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def isEmpty = true
</span><span line-number="3" class=""><span class="tooltip-container"></span>  def head = ???
</span><span line-number="4" class=""><span class="tooltip-container"></span>  def tail = ???
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Here is a formulation of the class for lazy cons nodes:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>import scala.compiletime.uninitialized
</span><span line-number="2" class=""><span class="tooltip-container"></span>
</span><span line-number="3" class=""><span class="tooltip-container"></span>final class LzyCons[+A](hd: A, tl: () =&gt; LzyList[A]^) extends LzyList[A]:
</span><span line-number="4" class=""><span class="tooltip-container"></span>  private var forced = false
</span><span line-number="5" class=""><span class="tooltip-container"></span>  private var cache: LzyList[A]^{this} = uninitialized
</span><span line-number="6" class=""><span class="tooltip-container"></span>  private def force =
</span><span line-number="7" class=""><span class="tooltip-container"></span>    if !forced then { cache = tl(); forced = true }
</span><span line-number="8" class=""><span class="tooltip-container"></span>    cache
</span><span line-number="9" class=""><span class="tooltip-container"></span>
</span><span line-number="10" class=""><span class="tooltip-container"></span>  def isEmpty = false
</span><span line-number="11" class=""><span class="tooltip-container"></span>  def head = hd
</span><span line-number="12" class=""><span class="tooltip-container"></span>  def tail: LzyList[A]^{this} = force
</span><span line-number="13" class=""><span class="tooltip-container"></span>end LzyCons
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The <code>LzyCons</code> class takes two parameters: A head <code>hd</code> and a tail <code>tl</code>, which is a function returning a <code>LzyList</code>. Both the function and its result can capture arbitrary capabilities. The result of applying the function is memoized after the first dereference of <code>tail</code> in the private mutable field <code>cache</code>. Note that the typing of the assignment <code>cache = tl()</code> relies on the monotonicity rule for <code>{this}</code> capture sets.</p>
    <p>Here is an extension method to define an infix cons operator <code>#:</code> for lazy lists. It is analogous to <code>::</code> but instead of a strict list it produces a lazy list without evaluating its right operand.</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>extension [A](x: A)
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def #:(xs1: =&gt; LzyList[A]^): LzyList[A]^{xs1} =
</span><span line-number="3" class=""><span class="tooltip-container"></span>    LzyCons(x, () =&gt; xs1)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Note that <code>#:</code> takes an impure call-by-name parameter <code>xs1</code> as its right argument. The result of <code>#:</code> is a lazy list that captures that argument.</p>
    <p>As an example usage of <code>#:</code>, here is a method <code>tabulate</code> that creates a lazy list of given length with a generator function <code>gen</code>. The generator function is allowed to have side effects.</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>def tabulate[A](n: Int)(gen: Int =&gt; A): LzyList[A]^{gen} =
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def recur(i: Int): LzyList[A]^{gen} =
</span><span line-number="3" class=""><span class="tooltip-container"></span>    if i == n then LzyNil
</span><span line-number="4" class=""><span class="tooltip-container"></span>    else gen(i) #: recur(i + 1)
</span><span line-number="5" class=""><span class="tooltip-container"></span>  recur(0)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Here is a use of <code>tabulate</code>:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>class LimitExceeded extends Exception
</span><span line-number="2" class=""><span class="tooltip-container"></span>def squares(n: Int)(using ct: CanThrow[LimitExceeded]) =
</span><span line-number="3" class=""><span class="tooltip-container"></span>  tabulate(10): i =&gt;
</span><span line-number="4" class=""><span class="tooltip-container"></span>    if i &gt; 9 then throw LimitExceeded()
</span><span line-number="5" class=""><span class="tooltip-container"></span>    i * i
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The inferred result type of <code>squares</code> is <code>LzyList[Int]^{ct}</code>, i.e it is a lazy list of <code>Int</code>s that can throw the <code>LimitExceeded</code> exception when it is elaborated by calling <code>tail</code> one or more times.</p>
    <p>Here are some further extension methods for mapping, filtering, and concatenating lazy lists:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>extension [A](xs: LzyList[A]^)
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def map[B](f: A =&gt; B): LzyList[B]^{xs, f} =
</span><span line-number="3" class=""><span class="tooltip-container"></span>    if xs.isEmpty then LzyNil
</span><span line-number="4" class=""><span class="tooltip-container"></span>    else f(xs.head) #: xs.tail.map(f)
</span><span line-number="5" class=""><span class="tooltip-container"></span>
</span><span line-number="6" class=""><span class="tooltip-container"></span>  def filter(p: A =&gt; Boolean): LzyList[A]^{xs, p} =
</span><span line-number="7" class=""><span class="tooltip-container"></span>    if xs.isEmpty then LzyNil
</span><span line-number="8" class=""><span class="tooltip-container"></span>    else if p(xs.head) then xs.head #: xs.tail.filter(p)
</span><span line-number="9" class=""><span class="tooltip-container"></span>    else xs.tail.filter(p)
</span><span line-number="10" class=""><span class="tooltip-container"></span>
</span><span line-number="11" class=""><span class="tooltip-container"></span>  def concat(ys: LzyList[A]^): LzyList[A]^{xs, ys} =
</span><span line-number="12" class=""><span class="tooltip-container"></span>    if xs.isEmpty then ys
</span><span line-number="13" class=""><span class="tooltip-container"></span>    else xs.head #: xs.tail.concat(ys)
</span><span line-number="14" class=""><span class="tooltip-container"></span>
</span><span line-number="15" class=""><span class="tooltip-container"></span>  def drop(n: Int): LzyList[A]^{xs} =
</span><span line-number="16" class=""><span class="tooltip-container"></span>    if n == 0 then xs else xs.tail.drop(n - 1)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>Their capture annotations are all as one would expect:</p>
    <ul>
     <li>Mapping a lazy list produces a lazy list that captures the original list as well as the (possibly impure) mapping function.</li>
     <li>Filtering a lazy list produces a lazy list that captures the original list as well as the (possibly impure) filtering predicate.</li>
     <li>Concatenating two lazy lists produces a lazy list that captures both arguments.</li>
     <li>Dropping elements from a lazy list gives a safe approximation where the original list is captured in the result. In fact, it's only some suffix of the list that is retained at run time, but our modelling identifies lazy lists and their suffixes, so this additional knowledge would not be useful.</li>
    </ul>
    <p>Of course the function passed to <code>map</code> or <code>filter</code> could also be pure. After all, <code>A -&gt; B</code> is a subtype of <code>(A -&gt; B)^{cap}</code> which is the same as <code>A =&gt; B</code>. In that case, the pure function argument will <em>not</em> show up in the result type of <code>map</code> or <code>filter</code>. For instance:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>val xs = squares(10)
</span><span line-number="2" class=""><span class="tooltip-container"></span>val ys: LzyList[Int]^{xs} = xs.map(_ + 1)
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>The type of the mapped list <code>ys</code> has only <code>xs</code> in its capture set. The actual function argument does not show up since it is pure. Likewise, if the lazy list <code>xs</code> was pure, it would not show up in any of the method results. This demonstrates that capability-based effect systems with capture checking are naturally <em>effect polymorphic</em>.</p>
    <p>This concludes our example. It's worth mentioning that an equivalent program defining and using standard, strict lists would require no capture annotations whatsoever. It would compile exactly as written now in standard Scala 3, yet one gets the capture checking for free. Essentially, <code>=&gt;</code> already means "can capture anything" and since in a strict list side effecting operations are not retained in the result, there are no additional captures to record. A strict list could of course capture side-effecting closures in its elements but then tunnelling applies, since these elements are represented by a type variable. This means we don't need to annotate anything there either.</p>
    <p>Another possibility would be a variant of lazy lists that requires all functions passed to <code>map</code>, <code>filter</code> and other operations like it to be pure. E.g. <code>map</code> on such a list would be defined like this:</p>
    <div class="snippet mono-small-block" scala-snippet="">
     <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>extension [A](xs: LzyList[A])
</span><span line-number="2" class=""><span class="tooltip-container"></span>  def map[B](f: A -&gt; B): LzyList[B] = ...
</span></code></pre>
     <div class="buttons"></div>
    </div>
    <p>That variant would not require any capture annotations either.</p>
    <p>To summarize, there are two "sweet spots" of data structure design: strict lists in side-effecting or resource-aware code and lazy lists in purely functional code. Both are already correctly capture-typed without requiring any explicit annotations. Capture annotations only come into play where the semantics gets more complicated because we deal with delayed effects such as in impure lazy lists or side-effecting iterators over strict lists. This property is probably one of the greatest plus points of our approach to capture checking compared to previous techniques which tend to be more noisy.</p>
   </section>
  </main>
  <div class="divider"></div>
  <nav class="arrow-navigation" aria-label="Page navigation">
   <div>
    <span class="body-small">Previous</span> <a rel="prev" href="basics.html" aria-keyshortcuts="Left" class="body-medium"> <span class="body-medium">Capture Checking Basics</span> </a>
   </div>
   <div>
    <span class="body-small arrow-navigation--next">Next</span> <a rel="next" href="polymorphism.html" aria-keyshortcuts="Right" class="body-medium"> <span class="body-medium">Capability Polymorphism</span> </a>
   </div>
  </nav>
  <div class="content-contributors hidden">
   <h1 class="h200">Contributors to this page</h1>
   <div id="documentation-contributors" class="contributors-container"></div>
   <div class="github-edit-button">
    <a class="text-button with-link body-small" href="https://github.com/scala/scala3/edit/main/docs/_docs/reference/experimental/capture-checking/classes.md"> Edit this page on GitHub </a>
   </div>
  </div>
 </div>
</div></div><div id="toc" class="body-small"><div id="toc-container"><span class="toc-title h200">In this article</span><nav class="toc-nav"><ul class="toc-list"><li><a href="#introduction">Introduction</a></li><li><a href="#capture-tunnelling">Capture Tunnelling</a></li><li><a href="#a-larger-example">A Larger Example</a></li></ul></nav></div></div></div><div id="footer" class="body-small mobile-footer"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/scala/scala3"><button class="icon-button gh"></button></a><a href="https://discord.com/invite/scala"><button class="icon-button discord"></button></a><a href="https://twitter.com/scala_lang"><button class="icon-button twitter"></button></a><div class="text">Copyright (c) 2002-2025, LAMP/EPFL</div></div><div class="text-mobile">Copyright (c) 2002-2025, LAMP/EPFL</div></div></div></div></body></html>